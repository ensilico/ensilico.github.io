<html>
    <head>
        <script src="ensilico.js"></script>
        <script>
            function Cast() {
                this.gravity = new Pair();
                this.gravity.load({
                    x: 0,
                    y: -9.81
                });

                var initialAngle = Scalar.toRadians(30);
                this.bot = new Bot({
                    position: {
                        x: 3,
                        y: -3
                    },
                    minAngle: initialAngle,
                    maxAngle: Scalar.toRadians(150),
                    gain: 0.01,
                    responsiveness: 10
                });

                this.rod = new Rod({
                    overallLength: 3,
                    pivotOffset: 0.2,
                    mass: 0.1,
                    spring: 18,
                    damping: 0.3,
                    drag: 0.1
                });
                this.rod.alignTo(initialAngle);

                this.filament = new Filament({}, this.rod.tipPosition);
                this.lure = new Particle();
                this.lure.position.load(this.filament.position[Filament.numSegments()]);

                // Avoid object allocation in inner loop
                this.reusage = {
                    targetPosition: new Pair(),
                    targetVelocity: new Pair(),
                    headForce: new Pair(),
                    tailForce: new Pair()
                };
            }

            Cast.prototype.preferences = function() {
                return {
                    visualScale: 32,
                    stepsize: 0.0003
                };
            }

            Cast.prototype.update = function(controls) {
                var stepsize = controls.stepsize;

                this.filament.update(
                    stepsize,
                    this.gravity,
                    this.rod.tipPosition,
                    this.rod.tipVelocity,
                    this.lure.position,
                    this.lure.velocity);
                this.filament.storeHeadForce(this.gravity, this.reusage.headForce);
                this.filament.storeTailForce(this.gravity, this.reusage.tailForce);
                this.lure.update(stepsize, this.gravity, this.reusage.tailForce);

                this.bot.update(stepsize, controls.pointer.contact, controls.pointer.displacement.y);

                var targetPosition = this.reusage.targetPosition;
                targetPosition.loadPolar(this.rod.radius(), this.bot.angle);

                var targetVelocity = this.reusage.targetVelocity;
                targetVelocity.loadCrossProduct(this.bot.rate, targetPosition);

                this.rod.update(stepsize, this.gravity, this.reusage.headForce, targetPosition, targetVelocity);
            }

            Cast.prototype.visualize = function(context, elapsedTime) {
                context.save();
                context.translate(this.bot.position.x, this.bot.position.y);

                // Rod flex curve
                var r = -this.rod.pivotOffset;
                var x = Math.cos(this.bot.angle);
                var y = Math.sin(this.bot.angle);
                context.moveTo(r * x, r * y);

                r = 0.75 * this.rod.radius();
                context.quadraticCurveTo(r * x, r * y, this.rod.tipPosition.x, this.rod.tipPosition.y);

                this.filament.visualize(context, elapsedTime);

                context.restore();
            }

            function Bot(properties) {
                // Default values
                this.position = {
                    x: 0,
                    y: 0
                };
                this.minAngle = 0;
                this.maxAngle = Scalar.toRadians(90);
                this.gain = 0.01;
                this.responsiveness = 1;

                // Allow caller to override
                Platform.softCopy(this, properties);

                this.angle = this.minAngle;
                this.rate = 0;
                this.captureAngle = this.angle;
            }

            Bot.prototype.update = function(stepsize, pointerContact, pointerDisplacement) {
                this.captureAngle = Scalar.lerp(this.angle, this.captureAngle, pointerContact);
                var target = pointerContact * pointerDisplacement * this.gain + this.captureAngle;
                this.rate = Scalar.lagRate(this.angle, target, this.responsiveness, stepsize);
                this.angle += stepsize * this.rate;
            }
       </script>
    </head>
    <body onload="Executive.startFromJson('cast', new Cast(), 'cast.json')">
        <canvas id="cast" width="800" height="600">
            Opps.
        </canvas>
    </body>
</html>
